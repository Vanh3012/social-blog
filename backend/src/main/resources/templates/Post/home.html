<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:replace="~{layout/base :: layout(~{::content})}">

<body>
    <div th:fragment="content">
        <div class="grid md:grid-cols-[1fr] gap-6">
            <!-- Ph·∫ßn n·ªôi dung gi·ªØ nguy√™n -->
            <div>
                <!-- Composer -->
                <div sec:authorize="isAuthenticated()"
                    class="rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm mb-4">
                    <form th:action="@{/post/create}" method="post" x-data="{loading:false}" @submit="loading=true">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                        <textarea name="content" rows="2" placeholder="Chia s·∫ª g√¨ ƒë√≥..." required
                            class="w-full resize-none rounded-xl border border-neutral-300 px-3 py-2 focus:ring-2 focus:ring-neutral-900"></textarea>

                        <div class="mt-3 flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                            <input name="imageUrl" placeholder="Link h√¨nh (t√πy ch·ªçn)"
                                class="flex-1 rounded-xl border border-neutral-300 px-3 py-2 focus:ring-2 focus:ring-neutral-900">

                            <select name="visibility"
                                class="rounded-xl border border-neutral-300 px-3 py-2 focus:ring-2 focus:ring-neutral-900">
                                <option value="PUBLIC">üåç C√¥ng khai</option>
                                <option value="FRIENDS">üë• B·∫°n b√®</option>
                                <option value="PRIVATE">üîí Ri√™ng t∆∞</option>
                            </select>

                            <button type="submit"
                                class="rounded-lg bg-neutral-900 text-white px-4 py-2.5 hover:bg-black disabled:opacity-50 whitespace-nowrap"
                                :disabled="loading" x-text="loading?'ƒêang ƒëƒÉng...':'ƒêƒÉng b√†i'">ƒêƒÉng b√†i</button>
                        </div>
                    </form>
                </div>

                <!-- Feed -->
                <div class="space-y-4">
                    <div th:each="post : ${posts}" class="rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-neutral-900 to-neutral-600 flex items-center justify-center text-white font-semibold"
                                    th:text="${post.author.fullName != null ? #strings.substring(post.author.fullName, 0, 1) : 'U'}">
                                    U
                                </div>
                                <div>
                                    <div class="font-medium" th:text="${post.author.fullName ?: post.author.username}">
                                        T√™n</div>
                                    <div class="text-xs text-neutral-500"
                                        th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}">time</div>
                                </div>
                            </div>
                            <div class="text-xs px-2 py-1 rounded bg-neutral-100 text-neutral-600" th:text="${post.visibility.toString() == 'PUBLIC' ? 'üåç' : 
                                         (post.visibility.toString() == 'FRIENDS' ? 'üë•' : 'üîí')}">
                                üåç
                            </div>
                        </div>

                        <div class="mt-3 whitespace-pre-wrap text-neutral-900" th:text="${post.content}">N·ªôi dung...
                        </div>

                        <img th:if="${post.imageUrl != null and !#strings.isEmpty(post.imageUrl)}"
                            th:src="${post.imageUrl}" alt="Post image"
                            class="mt-3 rounded-xl border border-neutral-200 w-full object-cover max-h-96" />

                        <div
                            class="mt-4 pt-3 border-t border-neutral-100 flex items-center justify-between text-sm text-neutral-600">
                            <div class="flex items-center gap-4">
                                <span>‚ù§Ô∏è <span th:text="${post.likeCount}">0</span></span>
                                <span>üí¨ <span th:text="${post.commentCount}">0</span></span>
                            </div>
                        </div>

                        <div class="mt-3 flex items-center gap-2">
                            <button sec:authorize="isAuthenticated()" onclick="toggleReactionForm(this)" type="button"
                                class="flex-1 rounded-lg border border-neutral-300 px-3 py-2 text-sm hover:bg-neutral-50 transition">
                                Th·∫£ c·∫£m x√∫c
                            </button>
                            <a th:href="@{|/post/${post.id}|}"
                                class="flex-1 text-center rounded-lg border border-neutral-300 px-3 py-2 text-sm hover:bg-neutral-50 transition">
                                Xem chi ti·∫øt
                            </a>
                        </div>

                        <!-- Reaction form -->
                        <div class="mt-2 hidden reaction-form" sec:authorize="isAuthenticated()">
                            <form th:action="@{/reaction/add}" method="post" class="flex items-center gap-2">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <input type="hidden" name="postId" th:value="${post.id}" />
                                <select name="type" required
                                    class="flex-1 rounded-lg border border-neutral-300 px-2 py-1.5 text-sm">
                                    <option value="LIKE">üëç Like</option>
                                    <option value="LOVE">‚ù§Ô∏è Love</option>
                                    <option value="HAHA">üòÇ Haha</option>
                                    <option value="WOW">üòÆ Wow</option>
                                    <option value="SAD">üò¢ Sad</option>
                                    <option value="ANGRY">üò† Angry</option>
                                </select>
                                <button type="submit"
                                    class="rounded-lg bg-neutral-900 text-white px-3 py-1.5 text-sm hover:bg-black">
                                    G·ª≠i
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div th:if="${posts == null or #lists.isEmpty(posts)}"
                    class="text-center text-neutral-500 py-16 bg-white rounded-2xl border border-neutral-200">
                    <div class="text-4xl mb-2">üì≠</div>
                    <p>Ch∆∞a c√≥ b√†i vi·∫øt n√†o.</p>
                    <a sec:authorize="isAuthenticated()" th:href="@{/post/create}"
                        class="inline-block mt-4 text-neutral-900 underline underline-offset-4">
                        T·∫°o b√†i vi·∫øt ƒë·∫ßu ti√™n
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleReactionForm(button) {
            const form = button.parentElement.nextElementSibling;
            form.classList.toggle('hidden');
        }
    </script>
</body>

</html>