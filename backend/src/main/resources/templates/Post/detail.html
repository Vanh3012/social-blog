<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:with="pageTitle='B√†i vi·∫øt', content='this :: content'" 
    th:replace="~{layout/base :: layout(~{::content})}">

<body>
    <section th:fragment="content">
        <div class="max-w-3xl mx-auto">
            <article class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
                <div class="flex items-start justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-neutral-900 to-neutral-600 flex items-center justify-center text-white font-semibold text-lg"
                            th:text="${post.author.fullName != null ? #strings.substring(post.author.fullName, 0, 1) : 'U'}">
                            U
                        </div>
                        <div>
                            <div class="font-medium" th:text="${post.author.fullName ?: post.author.username}">T√™n</div>
                            <div class="text-xs text-neutral-500"
                                th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}">time</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2" sec:authorize="isAuthenticated()">
                        <div th:if="${currentUser != null and currentUser.id == post.author.id}">
                            <a th:href="@{|/post/${post.id}/edit|}"
                                class="rounded-lg border border-neutral-300 px-3 py-1.5 text-sm hover:bg-neutral-100">S·ª≠a</a>
                            <form th:action="@{|/post/${post.id}/delete|}" method="post" style="display: inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="submit"
                                    class="rounded-lg border border-red-300 text-red-600 px-3 py-1.5 text-sm hover:bg-red-50"
                                    data-confirm="X√≥a b√†i vi·∫øt n√†y?">Xo√°</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="mt-4 whitespace-pre-wrap text-neutral-900 leading-relaxed" th:text="${post.content}">N·ªôi
                    dung...</div>

                <img th:if="${post.imageUrl != null and !#strings.isEmpty(post.imageUrl)}" th:src="${post.imageUrl}"
                    alt="Post image" class="mt-4 rounded-xl border border-neutral-200 w-full object-cover max-h-96" />

                <div
                    class="mt-4 pt-3 border-t border-neutral-100 flex items-center justify-between text-sm text-neutral-600">
                    <div class="flex items-center gap-4">
                        <span>‚ù§Ô∏è <span th:text="${post.likeCount}">0</span> l∆∞·ª£t th√≠ch</span>
                        <span>üí¨ <span th:text="${post.commentCount}">0</span> b√¨nh lu·∫≠n</span>
                    </div>
                    <div class="text-xs px-2 py-1 rounded bg-neutral-100" th:text="${post.visibility.toString() == 'PUBLIC' ? 'üåç C√¥ng khai' : 
                                 (post.visibility.toString() == 'FRIENDS' ? 'üë• B·∫°n b√®' : 'üîí Ri√™ng t∆∞')}">
                        Visibility
                    </div>
                </div>

                <div class="mt-4 flex items-center gap-2" sec:authorize="isAuthenticated()">
                    <button onclick="toggleReactionForm()" type="button"
                        class="flex-1 rounded-lg border border-neutral-300 px-3 py-2 text-sm hover:bg-neutral-50 transition">
                        Th·∫£ c·∫£m x√∫c
                    </button>
                </div>

                <!-- Reaction form -->
                <div id="reactionForm" class="mt-3 hidden" sec:authorize="isAuthenticated()">
                    <form th:action="@{/reaction/add}" method="post" class="flex items-center gap-2">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="postId" th:value="${post.id}" />
                        <select name="type" required
                            class="flex-1 rounded-lg border border-neutral-300 px-3 py-2 text-sm">
                            <option value="LIKE">üëç Like</option>
                            <option value="LOVE">‚ù§Ô∏è Love</option>
                            <option value="HAHA">üòÇ Haha</option>
                            <option value="WOW">üòÆ Wow</option>
                            <option value="SAD">üò¢ Sad</option>
                            <option value="ANGRY">üò† Angry</option>
                        </select>
                        <button type="submit"
                            class="rounded-lg bg-neutral-900 text-white px-4 py-2 text-sm hover:bg-black">
                            G·ª≠i
                        </button>
                    </form>
                </div>
            </article>

            <!-- Comments Section -->
            <section class="mt-6 space-y-4">
                <div class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
                    <h2 class="font-semibold mb-4 text-lg">B√¨nh lu·∫≠n</h2>

                    <div th:if="${comments == null or #lists.isEmpty(comments)}"
                        class="text-sm text-neutral-500 text-center py-8">
                        <div class="text-3xl mb-2">üí¨</div>
                        Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o
                    </div>

                    <div th:each="c : ${comments}" class="py-3 border-t first:border-t-0 border-neutral-100">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex items-start gap-3 flex-1">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-neutral-700 to-neutral-500 flex items-center justify-center text-white font-semibold text-sm flex-shrink-0"
                                    th:text="${c.author.fullName != null ? #strings.substring(c.author.fullName, 0, 1) : 'U'}">
                                    U
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-baseline gap-2">
                                        <div class="text-sm font-medium"
                                            th:text="${c.author.fullName ?: c.author.username}">User</div>
                                        <div class="text-xs text-neutral-500"
                                            th:text="${#temporals.format(c.createdAt, 'dd/MM/yyyy HH:mm')}">time</div>
                                    </div>
                                    <div class="mt-1 whitespace-pre-wrap text-sm text-neutral-900"
                                        th:text="${c.content}">N·ªôi dung comment</div>
                                </div>
                            </div>
                            <div sec:authorize="isAuthenticated()"
                                th:if="${currentUser != null and currentUser.id == c.author.id}">
                                <form th:action="@{|/comment/${c.id}/delete|}" method="post">
                                    <input type="hidden" name="postId" th:value="${post.id}" />
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="text-xs text-red-600 hover:underline"
                                        data-confirm="X√≥a b√¨nh lu·∫≠n n√†y?">Xo√°</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add comment form -->
                <div sec:authorize="isAuthenticated()"
                    class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
                    <h3 class="font-semibold mb-3">Vi·∫øt b√¨nh lu·∫≠n</h3>
                    <form th:action="@{/comment/add}" method="post" x-data="{loading:false}" @submit="loading=true">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="postId" th:value="${post.id}" />
                        <textarea name="content" rows="3" required placeholder="Vi·∫øt b√¨nh lu·∫≠n..."
                            class="w-full rounded-xl border border-neutral-300 px-3 py-2 focus:ring-2 focus:ring-neutral-900"></textarea>
                        <div class="mt-3">
                            <button type="submit"
                                class="rounded-lg bg-neutral-900 text-white px-4 py-2.5 hover:bg-black disabled:opacity-50"
                                :disabled="loading" x-text="loading?'ƒêang g·ª≠i...':'B√¨nh lu·∫≠n'">B√¨nh lu·∫≠n</button>
                        </div>
                    </form>
                </div>
            </section>
        </div>
    </section>

    <script>
        function toggleReactionForm() {
            document.getElementById('reactionForm').classList.toggle('hidden');
        }
    </script>
</body>

</html>