<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:with="pageTitle='Tin nh·∫Øn', content='this :: content'" 
    th:replace="~{layout/base :: layout(~{::content})}">

<body>
    <section th:fragment="content">
        <div class="max-w-3xl mx-auto">
            <div class="rounded-2xl border border-neutral-200 bg-white shadow-sm overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-neutral-200 bg-neutral-50">
                    <div class="flex items-center justify-between">
                        <h1 class="text-lg font-semibold">Cu·ªôc h·ªôi tho·∫°i</h1>
                        <a th:href="@{/message/conversations}" class="text-sm text-neutral-600 hover:text-neutral-900">
                            ‚Üê Quay l·∫°i
                        </a>
                    </div>
                </div>

                <!-- Messages -->
                <div class="p-6 space-y-3 max-h-[500px] overflow-y-auto">
                    <div th:if="${messages == null or #lists.isEmpty(messages)}"
                        class="text-center text-neutral-500 py-8">
                        <div class="text-3xl mb-2">üí¨</div>
                        Ch∆∞a c√≥ tin nh·∫Øn n√†o
                    </div>

                    <div th:each="m : ${messages}"
                        th:classappend="${currentUser != null and m.sender.id == currentUser.id} ? 'flex justify-end' : 'flex justify-start'">
                        <div class="max-w-[75%] rounded-2xl px-4 py-2"
                            th:classappend="${currentUser != null and m.sender.id == currentUser.id} ? 'bg-neutral-900 text-white' : 'bg-neutral-100 text-neutral-900'">
                            <div class="text-xs mb-1"
                                th:classappend="${currentUser != null and m.sender.id == currentUser.id} ? 'opacity-70' : 'opacity-60'"
                                th:text="${m.sender.fullName ?: m.sender.username}">
                                Sender
                            </div>
                            <div class="whitespace-pre-wrap text-sm" th:text="${m.content}">N·ªôi dung</div>
                            <div class="text-[11px] mt-1"
                                th:classappend="${currentUser != null and m.sender.id == currentUser.id} ? 'opacity-60' : 'opacity-50'"
                                th:text="${#temporals.format(m.createdAt,'dd/MM HH:mm')}">
                                time
                            </div>
                            <form th:if="${currentUser != null and m.sender.id == currentUser.id}"
                                th:action="@{|/message/${m.id}/delete|}" method="post" class="text-right mt-1">
                                <input type="hidden" name="conversationId" th:value="${conversationId}" />
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="submit" class="text-[11px] hover:underline"
                                    th:classappend="${currentUser != null and m.sender.id == currentUser.id} ? 'text-red-300' : 'text-red-600'"
                                    data-confirm="Xo√° tin nh·∫Øn n√†y?">Xo√°</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Send box -->
                <div class="px-6 py-4 border-t border-neutral-200 bg-neutral-50">
                    <form th:action="@{/message/send}" method="post" x-data="{loading:false, content:''}"
                        @submit="loading=true">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="conversationId" th:value="${conversationId}" />

                        <textarea name="content" x-model="content" rows="2" required placeholder="Nh·∫≠p tin nh·∫Øn..."
                            class="w-full rounded-xl border border-neutral-300 px-3 py-2 focus:ring-2 focus:ring-neutral-900 resize-none"></textarea>

                        <div class="mt-3 flex items-center justify-between">
                            <div class="text-xs text-neutral-500">Nh·∫•n Shift+Enter ƒë·ªÉ xu·ªëng d√≤ng</div>
                            <button type="submit" :disabled="loading || content.trim().length==0"
                                class="rounded-lg bg-neutral-900 text-white px-4 py-2.5 hover:bg-black disabled:opacity-50"
                                x-text="loading?'ƒêang g·ª≠i...':'G·ª≠i'">G·ª≠i</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
</body>

</html>